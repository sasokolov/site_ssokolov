<!DOCTYPE html>


  

<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ext4 file-based encryption | Сергей Соколов</title>
    <link rel="icon" href="/images/S.png" sizes="32x32" />
    <link rel="icon" href="/images/S.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="/images/S.png" />
    <meta name="description" content="Личный сайт">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    <link rel="stylesheet" href="/css/style.css">
    
</head>
<body class="post">
    <a class="sidebar-toggle open"><div class="dashicons dashicons-menu"></div></a>
    <div id="page" class="site">
        <header id="masthead" class="site-header">
            


  
  


<a href="/en/" class="site-logo-link" rel="home">
    <img width="150" height="150" src="/images/S.png" class="site-logo" alt="Сергей Соколов" />
</a>
<div class="site-branding">
    <h1 class="site-title"><a href="/en/" rel="home">Sergey Sokolov</a></h1>
    <h2 class="site-description">Personal Website</h2>
</div>
<nav id="site-navigation" class="main-navigation">
    <button class="menu-toggle">Main Menu</button>
    <a class="skip-link screen-reader-text" href="#content">Skip to content</a>
    <div class="menu-container">
        <ul id="menu" class="menu">
            
              <li class="menu-item">
                <a href="/en/">Home</a>
              </li>
              <li class="menu-item">
                <a href="/en/services/">Services</a>
              </li>
              <li class="menu-item">
                <a href="/en/about/">About</a>
              </li>
              <li class="menu-item">
                <a href="/en/blog/">Blog</a>
              </li>
            
            
            <li class="menu-item menu-item-has-children">
                <a href="javascript:toggleLanguage('ru')" class="language-switcher-toggle">
                    
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAIAAAD5gJpuAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAHzSURBVHjaYkxOP8IAB//+Mfz7w8Dwi4HhP5CcJb/n/7evb16/APL/gRFQDiAAw3JuAgAIBEDQ/iswEERjGzBQLEru97ll0g0+3HvqMn1SpqlqGsZMsZsIe0SICA5gt5a/AGIEarCPtFh+6N/ffwxA9OvP/7//QYwff/6fZahmePeB4dNHhi+fGb59Y4zyvHHmCEAAAW3YDzQYaJJ93a+vX79aVf58//69fvEPlpIfnz59+vDhw7t37968efP3b/SXL59OnjwIEEAsDP+YgY53b2b89++/awvLn98MDi2cVxl+/vl6mituCtBghi9f/v/48e/XL86krj9XzwEEEENy8g6gu22rfn78+NGs5Ofr16+ZC58+fvyYwX8rxOxXr169fPny+fPn1//93bJlBUAAsQADZMEBxj9/GBxb2P/9+S/R8u3vzxuyaX8ZHv3j8/YGms3w8ycQARmi2eE37t4ACCDGR4/uSkrKAS35B3TT////wADOgLOBIaXIyjBlwxKAAGKRXjCB0SOEaeu+/y9fMnz4AHQxCP348R/o+l+//sMZQBNLEvif3AcIIMZbty7Ly6t9ZmXl+fXj/38GoHH/UcGfP79//BBiYHjy9+8/oUkNAAHEwt1V/vI/KBY/QSISFqM/GBg+MzB8A6PfYC5EFiDAABqgW776MP0rAAAAAElFTkSuQmCC" alt="English" width="16" height="11" style="width: 16px; height: 11px;" />
                    
                </a>
            </li>
        </ul>
    </div>
</nav>
        </header>
        <div id="content" class="site-content">
            <div id="primary" class="content-area">
                <main id="main" class="site-main">
                    
                    
<article class="post">
    <header class="entry-header">
        <h2 class="entry-title">ext4 file-based encryption</h2>
        <div class="entry-meta">
            
            <span class="posted-on">
                
                
                  
                
                Published 
                <a href="/en/blog/ext4-file-based-encryption/" rel="bookmark">
                    <time class="entry-date published" datetime="2016-11-16T00:00:00&#43;00:00">
                        
                            16.11.2016
                        
                    </time>
                </a>
            </span>
            
            
            <span class="byline"> 
                
                
                  
                
                by
                <span class="author vcard">
                    <a class="url fn n" href="http://localhost:1313/author/sergey">Sergey</a>
                </span>
            </span>
            
        </div>
    </header>
    <div class="entry-content clearfix">
        <p>Starting with kernel 4.1, the <em>CONFIG_EXT4_ENCRYPTION</em> option was added. This feature enables encryption implementation in the ext4 driver. With it, you can encrypt specific parts of the file system, such as a specific directory.</p>
<p>It so happens that I use <a href="https://www.rosalinux.ru/rosa-fresh/">ROSA Fresh</a> on my desktop, but the latest release of this system, although it has a kernel version higher than 4.1, lacks the tools for such functionality. The necessary utilities only appeared in e2fsprogs-1.43. But no worries. On <a href="https://abf.io/">ABF</a>, I found a fresh build of R9 (it&rsquo;s not even alpha yet) and it has kernel v4.8.7 and e2fsprogs-1.43.3, which means everything necessary is already there. We download it, install it in a virtual machine, and try it out.</p>
<p>I was experimenting on a file system mounted at /home, device /dev/sda6.</p>
<ol>
<li>First, let&rsquo;s enable the functionality <strong>(don&rsquo;t enable this on a boot partition. GRUB won&rsquo;t understand it and won&rsquo;t be able to boot the system)</strong></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo tune2fs -O encrypt /dev/sda6
</span></span></code></pre></div><ol start="2">
<li>Now let&rsquo;s create a file with the salt:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#0086b3">echo</span> 0x<span style="color:#000;font-weight:bold">$(</span>head -c <span style="color:#099">16</span> /dev/urandom | xxd -p<span style="color:#000;font-weight:bold">)</span>&gt;~/.cryptoSalt
</span></span></code></pre></div><ol start="3">
<li>Create a directory that we will encrypt:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir ~/crypted
</span></span></code></pre></div><ol start="4">
<li>And apply encryption to it, entering the key from the keyboard:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/sbin/e4crypt add_key -S <span style="color:#d14">`</span>cat ~/.cryptoSalt<span style="color:#d14">`</span> ~/crypted
</span></span></code></pre></div><p>Now in the ~/crypted directory, you can create folders and files as usual.</p>
<p>After a reboot, you won&rsquo;t be able to read the contents. More precisely, you&rsquo;ll be able to see that there are files and directories, but their names will be distorted, and the contents of the files won&rsquo;t be readable at all. To see everything normally again, you need to execute again</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/usr/sbin/e4crypt add_key -S <span style="color:#d14">`</span>cat ~/.cryptoSalt<span style="color:#d14">`</span> ~/crypted
</span></span></code></pre></div><p>And if you forgot which key and with which salt you initially protected it, then you can forget about the contents; it&rsquo;s unlikely that you&rsquo;ll be able to recover it.</p>

    </div>
    <footer class="entry-footer">
        
        
          
        
        
        <span class="comments-link">
            <a href="/en/blog/ext4-file-based-encryption/#comments">Leave a comment</a>
        </span>
    </footer>
</article>

                </main>
            </div>
        </div>
        <footer id="colophon" class="site-footer">
            <div class="site-info">
    Sergey A. Sokolov © 2016-2025
</div>
        </footer>
    </div>
    <div id="secondary" class="widget-area" role="complementary">
        <a class="sidebar-toggle close"><div class="dashicons dashicons-dismiss"></div></a>
        


  
  


<aside class="widget widget_search">
    <form role="search" method="get" class="search-form" action="http://localhost:1313/search">
        <label>
            <span class="screen-reader-text">Search:</span>
            <input type="search" class="search-field" placeholder="Search…" value="" name="s" />
        </label>
        <input type="submit" class="search-submit" value="Search" />
    </form>
</aside>

<aside class="widget widget_recent_entries">
    <h3 class="widget-title">Recent Posts</h3>
    <ul>
        
          <li><a href="/en/blog/ext4-file-based-encryption/">ext4 file-based encryption</a></li>
          <li><a href="/en/blog/gost2012-certificate/">Self-signed GOST2012 Certificate</a></li>
          <li><a href="/en/blog/postgresql-some-queries/">PostgreSQL and Some Queries</a></li>
          <li><a href="/en/blog/rpm-cheatsheet/">RPM Cheatsheet</a></li>
        
    </ul>
</aside>

<aside class="widget widget_archives">
    <h3 class="widget-title">Archives</h3>
    <ul>
        <li><a href="/en/blog/">All Posts</a></li>
    </ul>
</aside>

<aside class="widget widget_categories">
    <h3 class="widget-title">Categories</h3>
    <ul>
        
        <li class="cat-item">
            <a href="/categories/news">news</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/notes">notes</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8">заметки</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/%D0%BD%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8">новости</a> (2)
        </li>
        
    </ul>
</aside>

<aside class="widget widget_meta">
    <h3 class="widget-title">Meta</h3>
    <ul>
        <li><a href="http://localhost:1313/">Log in</a></li>
        <li><a href="http://localhost:1313/index.xml">RSS Feed</a></li>
        <li><a href="https://wordpress.org/">WordPress.org</a></li>
    </ul>
</aside>
    </div>
    <script src="/js/main.js"></script>
</body>
</html>