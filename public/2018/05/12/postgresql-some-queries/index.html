<!DOCTYPE html>


<html lang="ru">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostgreSQL и некоторые запросы | Сергей Соколов</title>
    <link rel="icon" href="/images/S.png" sizes="32x32" />
    <link rel="icon" href="/images/S.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="/images/S.png" />
    <meta name="description" content="Личный сайт">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab">
    <link rel="stylesheet" href="/css/style.css">
    
</head>
<body class="post">
    <a class="sidebar-toggle open"><div class="dashicons dashicons-menu"></div></a>
    <div id="page" class="site">
        <header id="masthead" class="site-header">
            



<a href="/" class="site-logo-link" rel="home">
    <img width="150" height="150" src="/images/S.png" class="site-logo" alt="Сергей Соколов" />
</a>
<div class="site-branding">
    <h1 class="site-title"><a href="/" rel="home">Сергей Соколов</a></h1>
    <h2 class="site-description">Личный сайт</h2>
</div>
<nav id="site-navigation" class="main-navigation">
    <button class="menu-toggle">Основное меню</button>
    <a class="skip-link screen-reader-text" href="#content">Перейти к содержимому</a>
    <div class="menu-container">
        <ul id="menu" class="menu">
            
              
              <li class="menu-item">
                  <a href="/">Главная</a>
              </li>
              
              <li class="menu-item">
                  <a href="/services/">Услуги</a>
              </li>
              
              <li class="menu-item">
                  <a href="/about/">О себе</a>
              </li>
              
              <li class="menu-item">
                  <a href="/blog/">Блог</a>
              </li>
              
            
            
            <li class="menu-item menu-item-has-children">
                <a href="javascript:toggleLanguage('en')" class="language-switcher-toggle">
                    
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAALCAMAAABBPP0LAAAAdVBMVEX19f/u7vjm5/H+/v75+fng4Ove3ulFRfyysv6cnP6QkPmIiPh/f/YAAOYAAP1ycv5QUP06OvkxMfcoKPcgIPYUFPS0AADdaYzTRG/RPGnOM2LKLFzIIVPCEUZ7AAD0AQH7YGH3ODj0JyfzERDgAAD4TU3pAABIfLuPAAAAT0lEQVR4AQXBAQqDMAAAsZytyHzA/v9LYRS7JIAQMkBb0ATsgLoKInnHvIrHrdRaBzxupTDxuFUifUsp4R3zU4iwzmOyT1ibBtP2u3C+wB+SHBB5JNY7DAAAAABJRU5ErkJggg==" alt="Русский" width="16" height="11" style="width: 16px; height: 11px;" />
                    
                </a>
            </li>
        </ul>
    </div>
</nav>
        </header>
        <div id="content" class="site-content">
            <div id="primary" class="content-area">
                <main id="main" class="site-main">
                    
                    
<article class="post">
    <header class="entry-header">
        <h2 class="entry-title">PostgreSQL и некоторые запросы</h2>
        <div class="entry-meta">
            
            <span class="posted-on">
                
                
                Опубликовано 
                <a href="/2018/05/12/postgresql-some-queries/" rel="bookmark">
                    <time class="entry-date published" datetime="2018-05-12T00:00:00&#43;00:00">
                        
                            12.05.2018
                        
                    </time>
                </a>
            </span>
            
            
            <span class="byline"> 
                
                
                автором
                <span class="author vcard">
                    <a class="url fn n" href="http://localhost:1313/author/%D1%81%D0%B5%D1%80%D0%B3%D0%B5%D0%B9">Сергей</a>
                </span>
            </span>
            
        </div>
    </header>
    <div class="entry-content clearfix">
        <img src="/images/post.png" alt="структура базы" class="alignright" width="335" height="148" />
<p>Этот пост я пишу как частичную текстовую расшифровку <a href="https://youtu.be/7HFecftZ1qM?t=4482">видео</a> с 1:14:42. Не знаю как Вам, но я не особо люблю смотреть видюшки, и легче воспринимаю написанное текстом с примерами. Поэтому делаю заметку для себя, но если оно окажется еще кому-то полезным — буду рад.</p>
<p>Создадим таблички вот такой структуры как на картинке и заполним их данными:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#998;font-style:italic">-- Таблица с постами
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb"> </span>post(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>id<span style="color:#bbb"> </span>bigserial<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>person_id<span style="color:#bbb"> </span><span style="color:#0086b3">int8</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>created_at<span style="color:#bbb"> </span>timestamptz<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NOT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">NULL</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>something<span style="color:#bbb"> </span><span style="color:#0086b3">text</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Добавляем миллион записей с данными
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">INSERT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INTO</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>post(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>created_at,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>something<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>(random()<span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">10</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">^</span><span style="color:#099">5</span>)::<span style="color:#0086b3">int8</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>now()<span style="color:#000;font-weight:bold">-</span><span style="color:#bbb"> </span><span style="color:#0086b3">INTERVAL</span><span style="color:#bbb"> </span><span style="color:#d14">&#39;1 minute&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span>(random()<span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">60</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">24</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">365</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">2</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span>created_at,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>string_agg(<span style="color:#bbb"> </span>substr(<span style="color:#bbb"> </span><span style="color:#d14">&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVW XYZ0123456789 &#39;</span>,(<span style="color:#bbb"> </span>random()<span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">72</span><span style="color:#bbb"> </span>)::<span style="color:#0086b3">INTEGER</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span><span style="color:#099">1</span>,<span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb"> </span>),<span style="color:#bbb"> </span><span style="color:#d14">&#39;&#39;</span><span style="color:#bbb"> </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>generate_series(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#099">1</span>,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#099">100</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>i<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">%</span><span style="color:#bbb"> </span><span style="color:#099">10</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span>(random()<span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span><span style="color:#099">2000</span>)::<span style="color:#0086b3">INTEGER</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span>something<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>generate_series(<span style="color:#099">1</span>,<span style="color:#bbb"> </span><span style="color:#099">1000000</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">g</span>(i);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Удаляем записи записи одного автора у которых совпадает время
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">DELETE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>post<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">WHERE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>created_at<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">IN</span>(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>created_at<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>post<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">GROUP</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">BY</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>created_at<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">HAVING</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">COUNT</span>(<span style="color:#000;font-weight:bold">*</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span><span style="color:#099">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Индекс по времени
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">INDEX</span><span style="color:#bbb"> </span>i_post_created_at<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ON</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>post<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">USING</span><span style="color:#bbb"> </span>btree(created_at);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Уникальный индекс по дате и автору
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">UNIQUE</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">INDEX</span><span style="color:#bbb"> </span>u_post_author_id_created_at<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ON</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>post(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>person_id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>created_at<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Табличка с авторами
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">CREATE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>person<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#000;font-weight:bold">DISTINCT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ON</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>(person_id)<span style="color:#bbb"> </span>person_id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span>id,<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#d14">&#39;person_&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">||</span><span style="color:#bbb"> </span>person_id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">AS</span><span style="color:#bbb"> </span>name<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>post;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Первичный ключ
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>person<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">PRIMARY</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span>(id);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Внешний ключ. Не верьте тем, кто говорят что не нужно их использовать. С ними гораздо лучше.
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">ALTER</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">TABLE</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span>post<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">ADD</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">CONSTRAINT</span><span style="color:#bbb"> </span>fk_post_person_id<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FOREIGN</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">KEY</span>(person_id)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">REFERENCES</span><span style="color:#bbb"> </span>person(id);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">-- Собираем статистику
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">analyze</span><span style="color:#bbb"> </span>post;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">analyze</span><span style="color:#bbb"> </span>person;<span style="color:#bbb">
</span></span></span></code></pre></div><p>Далее пишем запросы которые выбирают какие-то данные из этих таблиц.
Первое и самое простое — посчитать количество постов, которое у нас есть в <strong>post</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">SELECT</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">COUNT</span>(<span style="color:#000;font-weight:bold">*</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">FROM</span><span style="color:#bbb"> </span>post;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">COUNT</span><span style="color:#bbb">  
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#998;font-style:italic">---------
</span></span></span><span style="display:flex;"><span><span style="color:#998;font-style:italic"></span><span style="color:#bbb"> </span><span style="color:#099">1000000</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>(<span style="color:#099">1</span><span style="color:#bbb"> </span><span style="color:#a61717;background-color:#e3d2d2">строка</span>)<span style="color:#bbb">
</span></span></span></code></pre></div><p>Этот запрос выполняется по следующему плану:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>explain analyse select count(*) from post;
</span></span><span style="display:flex;"><span>                                                      QUERY PLAN                                                      
</span></span><span style="display:flex;"><span>----------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span> Aggregate  (cost=142283.69..142283.70 rows=1 width=8) (actual time=388.014..388.014 rows=1 loops=1)
</span></span><span style="display:flex;"><span>   -&gt;  Seq Scan on post  (cost=0.00..139784.35 rows=999735 width=0) (actual time=0.032..327.397 rows=1000000 loops=1)
</span></span><span style="display:flex;"><span> Planning time: 0.241 ms
</span></span><span style="display:flex;"><span> Execution time: 388.114 ms
</span></span><span style="display:flex;"><span>(4 строки)
</span></span></code></pre></div><p>Видим сколько оно выполнялось. Это долго, если учесть что мы просто прочитали миллион строк и подсчитали их количество.</p>
<p>Самый быстрый и простой способ посмотреть сколько строчек в таблице — это заглянуть в статистику. Число будет не точным, но если у нас автовакуум настроен агрессивно и делает свою работу вовремя, то на полученное число можно ориентироваться:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>explain select count(*) from post;
</span></span><span style="display:flex;"><span>                             QUERY PLAN                             
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------
</span></span><span style="display:flex;"><span> Aggregate  (cost=142281.59..142281.60 rows=1 width=8)
</span></span><span style="display:flex;"><span>   -&gt;  Seq Scan on post  (cost=0.00..139782.67 rows=999567 width=0)
</span></span><span style="display:flex;"><span>(2 строки)
</span></span></code></pre></div><p>Мы только что запускали <em>analyze post;</em> так что значение <strong>999567</strong> очень близко к точному значению.</p>
<p>В ситуации когда нам необходимо количество постов одного конкретного автора мы можем заставить его делать <strong>Index Only Scan</strong> и это будет очень быстро</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>explain analyze SELECT count(person_id) from post where person_id=1;
</span></span><span style="display:flex;"><span>                                                                   QUERY PLAN                                                                   
</span></span><span style="display:flex;"><span>------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span> Aggregate  (cost=48.64..48.65 rows=1 width=8) (actual time=0.143..0.144 rows=1 loops=1)
</span></span><span style="display:flex;"><span>   -&gt;  Index Only Scan using u_post_author_id_created_at on post  (cost=0.42..48.61 rows=11 width=8) (actual time=0.060..0.115 rows=14 loops=1)
</span></span><span style="display:flex;"><span>         Index Cond: (person_id = 1)
</span></span><span style="display:flex;"><span>         Heap Fetches: 14
</span></span><span style="display:flex;"><span> Planning time: 0.395 ms
</span></span><span style="display:flex;"><span> Execution time: 0.277 ms
</span></span><span style="display:flex;"><span>(6 строк)
</span></span></code></pre></div><p>Здесь мы в качестве параметра <strong>count()</strong> подставляем то же индексированное поле, по которому ограничиваем выборку в выражении <strong>where</strong>, таким образом, из индекса мы получаем все необходимое для формирования результата и postgres даже не обращается к страницам самой таблицы. Тут важную роль играет селективность <strong>person_id</strong>. Если бы выборка получалась больше некоторого значения, то, возможно, было бы дешевле сделать <strong>Bitmap Index Scan</strong>. В любом случае актуальность статистики и карты видимости очень важны для правильной оценки оптимального плана.
Больше про count() можно почитать в статье Joe Nelson <a href="https://gist.github.com/begriffs/67839ff18176d5879e77954bfcd38f1f">Faster PostgreSQL Counting</a> или <a href="https://www.citusdata.com/blog/2016/10/12/count-performance/">тут</a></p>
<p>В следующем посте поговорим о пагинации и почему <strong>offset</strong> плохо.</p>

    </div>
    <footer class="entry-footer">
        
        
        
        <span class="comments-link">
            <a href="/2018/05/12/postgresql-some-queries/#comments">Оставить комментарий</a>
        </span>
    </footer>
</article>

                </main>
            </div>
        </div>
        <footer id="colophon" class="site-footer">
            <div class="site-info">
    Sergey A. Sokolov © 2016-2025
</div>
        </footer>
    </div>
    <div id="secondary" class="widget-area" role="complementary">
        <a class="sidebar-toggle close"><div class="dashicons dashicons-dismiss"></div></a>
        



<aside class="widget widget_search">
    <form role="search" method="get" class="search-form" action="http://localhost:1313/search">
        <label>
            <span class="screen-reader-text">Найти:</span>
            <input type="search" class="search-field" placeholder="Поиск…" value="" name="s" />
        </label>
        <input type="submit" class="search-submit" value="Поиск" />
    </form>
</aside>

<aside class="widget widget_recent_entries">
    <h3 class="widget-title">Свежие записи</h3>
    <ul>
        
          
          <li>
              <a href="/2019/02/14/gost2012-certificate/">Самоподписной сертификат gost2012</a>
          </li>
          
          <li>
              <a href="/2018/07/02/rpm-cheatsheet/">Шпаргалка rpm</a>
          </li>
          
          <li>
              <a href="/2018/05/12/postgresql-some-queries/">PostgreSQL и некоторые запросы</a>
          </li>
          
          <li>
              <a href="/2016/11/16/ext4-file-based-encryption/">ext4 file-based шифрование</a>
          </li>
          
        
    </ul>
</aside>

<aside class="widget widget_archives">
    <h3 class="widget-title">Архивы</h3>
    <ul>
        <li><a href="/blog/">Все записи</a></li>
    </ul>
</aside>

<aside class="widget widget_categories">
    <h3 class="widget-title">Рубрики</h3>
    <ul>
        
        <li class="cat-item">
            <a href="/categories/news">news</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/notes">notes</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/%D0%B7%D0%B0%D0%BC%D0%B5%D1%82%D0%BA%D0%B8">заметки</a> (2)
        </li>
        
        <li class="cat-item">
            <a href="/categories/%D0%BD%D0%BE%D0%B2%D0%BE%D1%81%D1%82%D0%B8">новости</a> (2)
        </li>
        
    </ul>
</aside>

<aside class="widget widget_meta">
    <h3 class="widget-title">Мета</h3>
    <ul>
        <li><a href="http://localhost:1313/">Войти</a></li>
        <li><a href="http://localhost:1313/index.xml">Лента записей</a></li>
        <li><a href="https://ru.wordpress.org/">WordPress.org</a></li>
    </ul>
</aside>
    </div>
    <script src="/js/main.js"></script>
</body>
</html>